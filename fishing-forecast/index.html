<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Smart fishing forecast with species-specific predictions, water temperature modeling, and solunar calculations.">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FishCast">
    <script>
        (function initializeThemeBeforeRender() {
            const THEME_STORAGE_KEY = 'themePreference';
            const LEGACY_THEME_KEY = 'theme';
            const THEME_COOKIE_KEY = 'fishcast_theme';

            function getThemeFromCookie() {
                const cookie = document.cookie
                    .split('; ')
                    .find((part) => part.startsWith(`${THEME_COOKIE_KEY}=`));
                return cookie ? decodeURIComponent(cookie.split('=')[1]) : null;
            }

            function getStoredThemePreference() {
                try {
                    return (
                        localStorage.getItem(THEME_STORAGE_KEY) ||
                        localStorage.getItem(LEGACY_THEME_KEY) ||
                        getThemeFromCookie() ||
                        'system'
                    );
                } catch (error) {
                    return getThemeFromCookie() || 'system';
                }
            }

            function resolveTheme(preference) {
                if (preference === 'system') {
                    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                }
                return preference;
            }

            document.documentElement.setAttribute('data-theme', resolveTheme(getStoredThemePreference()));
        })();
    </script>
    <link rel="manifest" href="/fishing-forecast/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/fishing-forecast/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/fishing-forecast/icon-512.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/fishing-forecast/icon-192.png">
    <title>FishCast - Smart Fishing Forecasts</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: #e0e0e0;
            --input-bg: #f8f9fa;
            --shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2c2c2c;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-color: #444;
            --input-bg: #3a3a3a;
            --shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        body {
            font-family: 'Lato', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(52, 152, 219, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(46, 204, 113, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(52, 152, 219, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        [data-theme="dark"] body::before {
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(52, 152, 219, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(46, 204, 113, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(52, 152, 219, 0.1) 0%, transparent 50%);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
        }
        
        .theme-toggle button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--bg-secondary);
            box-shadow: var(--shadow);
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.3s;
        }
        
        .theme-toggle button:hover {
            transform: scale(1.1);
        }
        
        header {
            text-align: center;
            padding: 60px 20px 40px;
        }
        
        .logo-text {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: 2px;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 0.9rem;
            letter-spacing: 4px;
            text-transform: uppercase;
            color: var(--text-secondary);
            font-weight: 300;
        }
        
        /* Favorites Section */
        .favorites-section {
            background: var(--bg-secondary);
            border-radius: 2px;
            padding: 20px;
            margin: 20px auto;
            max-width: 600px;
            box-shadow: var(--shadow);
        }
        
        .favorites-section h3 {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--text-primary);
        }
        
        .favorites-list {
            display: grid;
            gap: 10px;
        }
        
        .favorite-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--input-bg);
            border-radius: 2px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .favorite-item:hover {
            background: var(--border-color);
        }
        
        .favorite-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .favorite-location {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .favorite-remove {
            color: #e74c3c;
            cursor: pointer;
            padding: 5px 10px;
        }
        
        /* Form Styles */
        .form-card {
            background: var(--bg-secondary);
            border-radius: 2px;
            padding: 40px;
            margin: 40px auto;
            max-width: 600px;
            box-shadow: var(--shadow);
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .location-input-group {
            display: flex;
            gap: 10px;
        }
        
        .location-input-group input {
            flex: 1;
        }
        
        .geolocate-btn {
            width: 50px;
            padding: 12px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            border-radius: 2px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        
        .geolocate-btn:hover {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .geolocate-btn:disabled {
            background: #bdc3c7;
            color: white;
            border-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            font-size: 1rem;
            font-family: 'Lato', sans-serif;
            background: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 2px;
            transition: all 0.2s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        
        [data-theme="dark"] input:focus,
        [data-theme="dark"] select:focus {
            background: #404040;
        }
        
        input.validating {
            border-color: #f39c12;
            background: #fffbf0;
        }
        
        [data-theme="dark"] input.validating {
            background: #3a2f1f;
        }
        
        input.valid {
            border-color: #27ae60;
        }
        
        input.invalid {
            border-color: #e74c3c;
        }
        
        small {
            display: block;
            margin-top: 5px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
            color: #3498db;
        }
        
        input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 2px;
            background: var(--border-color);
            border: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #3498db;
            cursor: pointer;
            border-radius: 50%;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #3498db;
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }
        
        button {
            width: 100%;
            padding: 16px;
            font-size: 0.9rem;
            font-family: 'Lato', sans-serif;
            font-weight: 700;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #34495e;
        }
        
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Score Display */
        .score-header {
            background: var(--bg-secondary);
            border-radius: 2px;
            padding: 50px 30px;
            margin: 40px auto;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .score-header h2 {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 30px;
            color: var(--text-primary);
            letter-spacing: 1px;
        }
        
        .score-display {
            font-family: 'Cinzel', serif;
            font-size: 6rem;
            font-weight: 700;
            line-height: 1;
            margin: 20px 0;
        }
        
        .rating {
            font-size: 1.5rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin: 15px 0;
        }
        
        .location-info {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-top: 20px;
        }
        
        /* Detail Cards */
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .detail-card {
            background: var(--bg-secondary);
            border-radius: 2px;
            padding: 25px;
            box-shadow: var(--shadow);
        }
        
        .detail-card h3 {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--input-bg);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: var(--text-secondary);
            font-weight: 400;
        }
        
        .detail-value {
            font-weight: 600;
            color: var(--text-primary);
            text-align: right;
        }
        
        /* Technique Tips */
        .tips-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 2px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: var(--shadow);
        }
        
        .tips-card h3 {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tip-item {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 2px;
            margin: 10px 0;
            border-left: 3px solid rgba(255,255,255,0.5);
        }
        
        /* Calendar View */
        .calendar-view {
            background: var(--bg-secondary);
            border-radius: 2px;
            padding: 25px;
            margin: 40px 0;
            box-shadow: var(--shadow);
        }
        
        .calendar-view h3 {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .calendar-day {
            text-align: center;
            padding: 20px 10px;
            border-radius: 2px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .calendar-day:hover {
            transform: translateY(-2px);
        }
        
        .calendar-day-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .calendar-day-score {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'Cinzel', serif;
        }
        
        .calendar-day-rating {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }
        
        /* Forecast Grid */
        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .day-card {
            background: var(--bg-secondary);
            border-radius: 2px;
            padding: 30px;
            box-shadow: var(--shadow);
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .day-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .solunar-preview {
            margin-top: 10px;
            border: 1px solid var(--border-color);
            border-radius: 2px;
            padding: 12px;
            background: var(--bg-primary);
        }

        .day-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .day-details-item {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 2px;
            padding: 10px;
        }

        .day-details-item-label {
            color: var(--text-secondary);
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.7px;
            margin-bottom: 4px;
        }

        .day-details-item-value {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 0.95rem;
            line-height: 1.35;
        }
        
        .day-header {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
            text-align: center;
        }
        
        .day-score {
            font-size: 3.5rem;
            font-weight: 700;
            font-family: 'Cinzel', serif;
            text-align: center;
            margin: 15px 0;
        }
        
        .day-rating {
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .weather-detail {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--input-bg);
        }
        
        .weather-detail:last-child {
            border-bottom: none;
        }
        
        .weather-label {
            color: var(--text-secondary);
            font-weight: 400;
        }
        
        .weather-value {
            font-weight: 700;
            color: var(--text-primary);
        }
        
        /* Radar Section */
        .radar-section {
            background: var(--bg-secondary);
            border-radius: 2px;
            padding: 25px;
            margin: 40px 0;
            box-shadow: var(--shadow);
        }
        
        .radar-section h3 {
            font-family: 'Cinzel', serif;
            margin-bottom: 15px;
        }
        
        .radar-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .radar-controls button {
            padding: 8px 16px;
            background: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            width: auto;
            text-transform: none;
            letter-spacing: normal;
            font-size: 0.9rem;
        }
        
        .radar-controls button.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .radar-controls button:hover {
            background: #3498db;
            color: white;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .action-btn {
            padding: 12px 24px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            border-radius: 2px;
            cursor: pointer;
            font-family: 'Lato', sans-serif;
            font-weight: 600;
            width: auto;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .action-btn.primary {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .action-btn.success {
            background: #27ae60;
            color: white;
            border-color: #27ae60;
        }
        
        .action-btn.warning {
            background: #f39c12;
            color: white;
            border-color: #f39c12;
        }
        
        /* Catch Log */
        .catch-log-section {
            background: var(--bg-secondary);
            border-radius: 2px;
            padding: 25px;
            margin: 40px 0;
            box-shadow: var(--shadow);
        }
        
        .catch-log-section h3 {
            font-family: 'Cinzel', serif;
            margin-bottom: 20px;
        }
        
        .catch-form {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .catch-form input,
        .catch-form select {
            width: 100%;
        }
        
        .catch-list {
            display: grid;
            gap: 10px;
        }
        
        .catch-item {
            background: var(--input-bg);
            padding: 15px;
            border-radius: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .catch-info {
            flex: 1;
        }
        
        .catch-species {
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .catch-details {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        .catch-delete {
            color: #e74c3c;
            cursor: pointer;
            padding: 5px 10px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 2px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            margin-bottom: 20px;
        }
        
        .modal-close {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        /* Notification Badge */
        .notification-badge {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 12px 20px;
            border-radius: 2px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 999;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .error {
            background: #fee;
            border: 1px solid #e74c3c;
            border-radius: 2px;
            padding: 20px;
            margin: 40px auto;
            max-width: 600px;
            text-align: center;
            color: #c0392b;
        }
        
        footer {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        /* Color classes */
        .excellent { color: #27ae60; }
        .good { color: #2ecc71; }
        .fair { color: #f39c12; }
        .poor { color: #e67e22; }
        .bad { color: #e74c3c; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .logo-text {
                font-size: 2rem;
            }
            
            .score-display {
                font-size: 4rem;
            }
            
            .details-grid {
                grid-template-columns: 1fr;
            }
            
            .forecast-grid {
                grid-template-columns: 1fr;
            }
            
            .calendar-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <button id="waterTempBtn" onclick="openTempReport()" title="Submit water temperature">üå°Ô∏è</button>
        <button id="themeToggle" title="Toggle dark mode">üåô</button>
    </div>

    <div class="container">
        <header>
            <div class="logo-text">FishCast</div>
            <div class="subtitle">A science-based fishing forecast tool</div>
        </header>

        <!-- Favorites Section -->
        <div class="favorites-section" id="favoritesSection" style="display: none;">
            <h3>‚≠ê Favorite Spots</h3>
            <div id="favoritesList" class="favorites-list"></div>
        </div>

        <div class="form-card">
            <form id="forecastForm">
                <div class="form-group">
                    <label for="location">Location</label>
                    <div class="location-input-group">
                        <input 
                            type="text" 
                            id="location" 
                            placeholder="City, State or ZIP code"
                            required
                        >
                        <button type="button" id="geolocateBtn" class="geolocate-btn" title="Use my location">
                            üìç
                        </button>
                    </div>
                    <small>Examples: "Tupelo, MS" or "Memphis TN" or "38801"</small>
                </div>

                <div class="form-group">
                    <label for="species">Target Species</label>
                    <select id="species" required>
                        <option value="bass">Largemouth Bass</option>
                        <option value="crappie">Crappie</option>
                        <option value="bluegill">Bluegill</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="waterType">Water Body Type</label>
                    <select id="waterType" required>
                        <option value="lake">Lake (> 5 acres)</option>
                        <option value="pond">Pond (‚â§ 5 acres)</option>
                        <option value="reservoir">Reservoir (> 500 acres)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="days">Forecast Days</label>
                    <div class="slider-container">
                        <input 
                            type="range" 
                            id="days" 
                            min="3" 
                            max="10" 
                            value="7"
                            step="1"
                        >
                        <span class="slider-value" id="daysValue">7</span>
                    </div>
                </div>

                <button type="submit" id="submitBtn">
                    Generate Forecast
                </button>
            </form>
        </div>

        <div id="results"></div>

        <footer>
            <p><strong>FishCast</strong> - A product of The Southern Bluegill Association</p>
            <p style="margin-top: 10px;">
                <a href="mailto:thesouthernbluegill@gmail.com" style="color: var(--text-secondary); text-decoration: none;">thesouthernbluegill@gmail.com</a>
            </p>
            <p style="margin-top: 10px;">
                <a href="#" id="aboutLink" style="color: var(--text-secondary); text-decoration: none;">About</a> | 
                <a href="#" id="settingsLink" style="color: var(--text-secondary); text-decoration: none;">Settings</a>
            </p>
            <p style="margin-top: 15px; font-size: 0.85rem;">¬© 2026 The Southern Bluegill Association. All rights reserved.</p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="catchLogModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close" onclick="closeCatchLog()">√ó</span>
                üìä Log Your Catch
            </div>
            <div class="catch-form">
                <input type="number" id="catchCount" placeholder="Number of fish" min="0">
                <input type="number" id="catchSize" placeholder="Average size (inches)" min="0" step="0.1">
                <textarea id="catchNotes" placeholder="Notes (lure, location, etc.)" style="padding: 12px; font-family: 'Lato', sans-serif; border: 1px solid var(--border-color); border-radius: 2px; background: var(--input-bg); color: var(--text-primary); resize: vertical; min-height: 80px; font-size: 16px;"></textarea>
                <button onclick="saveCatch()" class="action-btn primary" style="width: 100%;">Save Catch</button>
            </div>
            <div id="catchHistory" style="margin-top: 30px;">
                <h4 style="margin-bottom: 15px;">Recent Catches</h4>
                <div id="catchList" class="catch-list"></div>
            </div>
        </div>
    </div>

    <div id="dayDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close" onclick="closeDayDetails()">√ó</span>
                <span id="dayDetailsTitle">üìÖ Day Details</span>
            </div>
            <div id="dayDetailsContent"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close" onclick="closeSettings()">√ó</span>
                ‚öôÔ∏è Settings
            </div>
            
            <div style="margin: 20px 0;">
                <h4 style="margin-bottom: 15px; color: var(--text-primary);">Default Settings</h4>
                <div style="background: var(--input-bg); padding: 15px; border-radius: 2px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-size: 0.9rem;">
                            Default Location
                        </label>
                        <input type="text" id="defaultLocation" placeholder="e.g., Tupelo, MS" 
                               style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 2px; background: var(--bg-secondary); color: var(--text-primary);">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-size: 0.9rem;">
                            Default Species
                        </label>
                        <select id="defaultSpecies" 
                                style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 2px; background: var(--bg-secondary); color: var(--text-primary);">
                            <option value="">None (always ask)</option>
                            <option value="bass">Largemouth Bass</option>
                            <option value="crappie">Crappie</option>
                            <option value="bluegill">Bluegill</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-size: 0.9rem;">
                            Default Water Body
                        </label>
                        <select id="defaultWaterBody" 
                                style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 2px; background: var(--bg-secondary); color: var(--text-primary);">
                            <option value="">None (always ask)</option>
                            <option value="pond">Pond (‚â§ 5 acres)</option>
                            <option value="lake">Lake (> 5 acres)</option>
                            <option value="reservoir">Reservoir (> 500 acres)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div style="margin: 20px 0;">
                <h4 style="margin-bottom: 15px; color: var(--text-primary);">Data Management</h4>
                <div style="background: var(--input-bg); padding: 15px; border-radius: 2px;">
                    <button onclick="exportAllData()" class="action-btn" style="width: 100%; margin-bottom: 10px;">
                        üì• Export All Data (JSON)
                    </button>
                    <button onclick="clearAllData()" class="action-btn" style="width: 100%; background: #e74c3c; border-color: #e74c3c;">
                        üóëÔ∏è Clear All Data
                    </button>
                    <small style="display: block; margin-top: 10px; color: var(--text-secondary);">
                        This will delete all favorites, catches, and settings. This cannot be undone.
                    </small>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button onclick="saveSettings()" class="action-btn primary" style="width: 100%;">
                    üíæ Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Water Temp Report Modal -->
    <div id="tempReportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close" onclick="closeTempReport()">√ó</span>
                üå°Ô∏è Submit Water Temperature
            </div>
            
            <form id="tempReportForm" onsubmit="submitTempReport(event); return false;">
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-size: 0.9rem;">
                        Location (City, State) *
                    </label>
                    <input type="text" id="reportLocation" required
                           placeholder="e.g., Tupelo, MS"
                           style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 2px; background: var(--input-bg); color: var(--text-primary);">
                </div>

                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-size: 0.9rem;">
                        Time *
                    </label>
                    <input type="datetime-local" id="reportDateTime" required
                           style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 2px; background: var(--input-bg); color: var(--text-primary);">
                </div>

                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-size: 0.9rem;">
                        Water Temperature (¬∞F) *
                    </label>
                    <input type="number" id="reportTemp" step="0.1" required
                           placeholder="e.g., 52.5"
                           style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 2px; background: var(--input-bg); color: var(--text-primary);">
                </div>

                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-size: 0.9rem;">
                        Water Body Type *
                    </label>
                    <select id="reportWaterBody" required
                            style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 2px; background: var(--input-bg); color: var(--text-primary);">
                        <option value="">Select type...</option>
                        <option value="pond">Pond (‚â§ 5 acres)</option>
                        <option value="lake">Lake (> 5 acres)</option>
                        <option value="reservoir">Reservoir (> 500 acres)</option>
                    </select>
                </div>

                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-size: 0.9rem;">
                        Depth of reading (feet) - Optional
                    </label>
                    <input type="number" id="reportDepth" step="1"
                           placeholder="e.g., 5"
                           style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 2px; background: var(--input-bg); color: var(--text-primary);">
                </div>

                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 5px; color: var(--text-primary); font-size: 0.9rem;">
                        Notes - Optional
                    </label>
                    <textarea id="reportNotes" rows="3"
                              placeholder="e.g., Clear water, sunny day, caught 3 bass"
                              style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 2px; background: var(--input-bg); color: var(--text-primary); resize: vertical; font-family: 'Lato', sans-serif; font-size: 16px;"></textarea>
                </div>

                <div style="background: #e8f4f8; padding: 15px; border-radius: 4px; margin: 20px 0; border-left: 4px solid #3498db;">
                    <p style="margin: 0; color: #2c3e50; font-size: 0.9rem;">
                        ‚ÑπÔ∏è <strong>Privacy Notice:</strong> Your location coordinates will be shared anonymously 
                        to help improve forecast accuracy for all anglers. This data helps The Southern Bluegill Association 
                        build better predictions for the entire fishing community.
                    </p>
                </div>

                <button type="submit" style="width: 100%; padding: 16px; background: #27ae60; color: white; border: none; border-radius: 2px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;">
                    üì§ Submit Report
                </button>
            </form>
        </div>
    </div>

    <!-- About Modal -->
    <div id="aboutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close" onclick="closeAbout()">√ó</span>
                ‚ÑπÔ∏è About FishCast
            </div>
            
            <div style="padding: 10px 0;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="font-family: 'Cinzel', serif; font-size: 2.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 10px;">
                        FishCast
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary); letter-spacing: 2px; text-transform: uppercase;">
                        Smart Fishing Forecasts
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 10px;">
                        Version 1.0.0
                    </div>
                </div>

                <div style="background: var(--input-bg); padding: 20px; border-radius: 2px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px; color: var(--text-primary);">What is FishCast?</h4>
                    <p style="color: var(--text-secondary); line-height: 1.6; margin: 0;">
                        FishCast is a science-based fishing forecast app that combines meteorological data, 
                        water temperature modeling, and solunar calculations to predict the best fishing times 
                        for your favorite species and locations.
                    </p>
                </div>

                <div style="background: var(--input-bg); padding: 20px; border-radius: 2px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px; color: var(--text-primary);">Features</h4>
                    <ul style="color: var(--text-secondary); line-height: 1.8; margin: 0; padding-left: 20px;">
                        <li>Species-specific predictions (Bass, Crappie, Bluegill)</li>
                        <li>Water temperature modeling with thermal lag</li>
                        <li>Solunar major/minor feeding periods</li>
                        <li>Weather radar integration</li>
                        <li>Catch logging and tracking</li>
                        <li>Favorite location management</li>
                        <li>Dark mode support</li>
                        <li>Works offline (PWA)</li>
                    </ul>
                </div>

                <div style="background: var(--input-bg); padding: 20px; border-radius: 2px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px; color: var(--text-primary);">Data Sources</h4>
                    <ul style="color: var(--text-secondary); line-height: 1.8; margin: 0; padding-left: 20px;">
                        <li><strong>Weather:</strong> Open-Meteo API (free, open-source)</li>
                        <li><strong>Geocoding:</strong> OpenStreetMap Nominatim</li>
                        <li><strong>Radar:</strong> Windy.com</li>
                        <li><strong>Solunar:</strong> Astronomical calculations (in-app)</li>
                    </ul>
                </div>

                <div style="background: var(--input-bg); padding: 20px; border-radius: 2px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px; color: var(--text-primary);">Privacy</h4>
                    <p style="color: var(--text-secondary); line-height: 1.6; margin: 0 0 15px 0;">
                        <strong>Your data stays on your device.</strong> FishCast does not collect, store, 
                        or transmit any personal information. All favorites, catches, and settings are stored 
                        locally in your browser. We don't use analytics, tracking, or third-party advertising.
                    </p>
                    
                    <h5 style="margin: 15px 0 10px 0; color: var(--text-primary);">Water Temperature Reports (Optional)</h5>
                    <p style="color: var(--text-secondary); line-height: 1.6; margin: 0;">
                        When you voluntarily submit a water temperature report, the following data is shared 
                        anonymously with The Southern Bluegill Association to improve forecast accuracy for all anglers:
                    </p>
                    <ul style="color: var(--text-secondary); line-height: 1.6; margin: 10px 0 10px 20px; padding: 0;">
                        <li>Location coordinates (city-level precision)</li>
                        <li>Water temperature measurement</li>
                        <li>Water body type (pond/lake/reservoir)</li>
                        <li>Optional: depth and notes</li>
                    </ul>
                    <p style="color: var(--text-secondary); line-height: 1.6; margin: 10px 0 0 0;">
                        <strong>This data is:</strong> ‚úÖ Anonymous ‚úÖ Voluntary ‚úÖ Used only to improve forecasts 
                        ‚úÖ Shared with the fishing community ‚ùå Never sold or used for advertising
                    </p>
                </div>

                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 2px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">How Scoring Works</h4>
                    <p style="line-height: 1.6; margin: 0; font-size: 0.9rem;">
                        Scores (0-100) combine water temperature, fish biology, barometric pressure trends, 
                        wind conditions, moon phase, and weather patterns. The algorithm is based on scientific 
                        research and field-tested data to predict fish activity levels.
                    </p>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>80-100:</span> <strong>EXCELLENT</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>65-79:</span> <strong>GOOD</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>50-64:</span> <strong>FAIR</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>35-49:</span> <strong>POOR</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>0-34:</span> <strong>BAD</strong>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; color: var(--text-secondary); font-size: 0.85rem; padding: 20px 0;">
                    <p style="margin: 5px 0;">A product of The Southern Bluegill Association</p>
                    <p style="margin: 5px 0;">¬© 2026 The Southern Bluegill Association</p>
                    <p style="margin: 15px 0 5px 0;">
                        <a href="mailto:thesouthernbluegill@gmail.com" 
                           style="color: var(--text-secondary); text-decoration: underline;">
                            thesouthernbluegill@gmail.com
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CORE DATA & UTILITIES
        // ============================================
        
        const SPECIES_DATA = {
            bass: {
                name: "Largemouth Bass",
                phases: {
                    winter: { temp_range: [35, 48], score_bonus: -10 },
                    pre_spawn: { temp_range: [48, 58], score_bonus: 20 },
                    spawn: { temp_range: [58, 70], score_bonus: 30 },
                    post_spawn: { temp_range: [70, 75], score_bonus: -5 },
                    early_summer: { temp_range: [75, 80], score_bonus: 18 },
                    summer: { temp_range: [80, 88], score_bonus: 12 },
                    fall: { temp_range: [58, 72], score_bonus: 25 }
                },
                preferences: {
                    wind_ideal: [5, 15],
                    loves_light_rain: true,
                    overcast_bonus: 8
                }
            },
            crappie: {
                name: "Crappie",
                phases: {
                    winter: { temp_range: [32, 45], score_bonus: -5 },
                    pre_spawn: { temp_range: [45, 55], score_bonus: 15 },
                    spawn: { temp_range: [55, 65], score_bonus: 30 },
                    post_spawn: { temp_range: [65, 70], score_bonus: 5 },
                    summer: { temp_range: [70, 85], score_bonus: 8 },
                    fall: { temp_range: [55, 70], score_bonus: 18 }
                },
                preferences: {
                    loves_overcast: true,
                    loves_calm: true,
                    pressure_sensitive: 40
                }
            },
            bluegill: {
                name: "Bluegill",
                phases: {
                    inactive: { temp_range: [0, 45], score_bonus: -15 },
                    cold: { temp_range: [45, 55], score_bonus: 5 },
                    pre_spawn: { temp_range: [55, 67], score_bonus: 18 },
                    spawn: { temp_range: [67, 74], score_bonus: 25 },
                    post_spawn: { temp_range: [74, 80], score_bonus: 12 },
                    summer: { temp_range: [80, 100], score_bonus: 10 }
                },
                preferences: {
                    spawn_needs_sun: true
                }
            }
        };

        const WATER_BODIES = {
            pond: { thermal_lag_days: 7, response_factor: 0.95 },
            lake: { thermal_lag_days: 14, response_factor: 0.92 },
            reservoir: { thermal_lag_days: 21, response_factor: 0.88 }
        };

        function kmhToMph(kmh) {
            return kmh * 0.621371;
        }

        function mmToIn(mm) {
            return mm * 0.0393701;
        }

        function getWindDirection(degrees) {
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            return directions[Math.round(degrees / 45) % 8];
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            let hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12 || 12;
            return `${hours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T12:00:00');
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}`;
        }

        function formatDateShort(dateStr) {
            const date = new Date(dateStr + 'T12:00:00');
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${days[date.getDay()]} ${months[date.getMonth()]} ${date.getDate()}`;
        }

        function getMoonPhaseIcon(phaseName) {
            const iconMap = {
                'New Moon': 'üåë',
                'Waxing Crescent': 'üåí',
                'First Quarter': 'üåì',
                'Waxing Gibbous': 'üåî',
                'Full Moon': 'üåï',
                'Waning Gibbous': 'üåñ',
                'Last Quarter': 'üåó',
                'Waning Crescent': 'üåò'
            };
            return iconMap[phaseName] || 'üåô';
        }

        function calculateSolunar(lat, lon, date) {
            const julianDay = date.getTime() / 86400000 + 2440587.5;
            const synodicMonth = 29.530588853;
            const moonAge = (julianDay - 2451550.1) % synodicMonth;
            const normalizedMoonAge = moonAge < 0 ? moonAge + synodicMonth : moonAge;
            const phase = normalizedMoonAge / synodicMonth;
            
            const illumination = (1 - Math.cos(phase * 2 * Math.PI)) / 2 * 100;
            
            let phaseName;
            if (phase < 0.03 || phase >= 0.97) phaseName = "New Moon";
            else if (phase < 0.1875) phaseName = "Waxing Crescent";
            else if (phase < 0.3125) phaseName = "First Quarter";
            else if (phase < 0.4375) phaseName = "Waxing Gibbous";
            else if (phase < 0.5625) phaseName = "Full Moon";
            else if (phase < 0.6875) phaseName = "Waning Gibbous";
            else if (phase < 0.8125) phaseName = "Last Quarter";
            else phaseName = "Waning Crescent";
            
            const baseHour = 12 + Math.floor(phase * 24);
            
            const formatPeriod = (start, end) => {
                start = start % 24;
                end = end % 24;
                return `${start.toString().padStart(2, '0')}:00-${end.toString().padStart(2, '0')}:00`;
            };
            
            return {
                moon_phase: phaseName,
                illumination: illumination,
                major_periods: [
                    formatPeriod(baseHour - 1, baseHour + 1),
                    formatPeriod(baseHour + 11, baseHour + 13)
                ],
                minor_periods: [
                    formatPeriod(baseHour + 5, baseHour + 6),
                    formatPeriod(baseHour + 17, baseHour + 18)
                ]
            };
        }

        // ============================================
        // LOCATION PARSING & GEOCODING
        // ============================================
        
        function parseLocation(input) {
            input = input.trim();
            
            const zipPattern = /^\d{5}$/;
            if (zipPattern.test(input)) {
                return { type: 'zip', value: input };
            }
            
            if (input.includes(',')) {
                const parts = input.split(',').map(s => s.trim());
                if (parts.length === 2) {
                    return { type: 'city_state', city: parts[0], state: parts[1] };
                }
            }
            
            const words = input.split(/\s+/);
            if (words.length >= 2) {
                const possibleState = words[words.length - 1].toUpperCase();
                if (possibleState.length === 2) {
                    const city = words.slice(0, -1).join(' ');
                    return { type: 'city_state', city: city, state: possibleState };
                }
            }
            
            return { type: 'city_only', value: input };
        }

        async function getLocation(locationInput) {
            const parsed = parseLocation(locationInput);
            
            if (parsed.type === 'zip') {
                const url = `https://nominatim.openstreetmap.org/search?postalcode=${parsed.value}&country=US&format=json&limit=1`;
                
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'FishCast/1.0' }
                });
                
                const data = await response.json();
                if (data && data.length > 0) {
                    const displayName = data[0].display_name;
                    const parts = displayName.split(', ');
                    let cityName = parts[0];
                    let stateName = parts.length > 2 ? parts[parts.length - 2] : 'US';
                    
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon),
                        name: `${cityName}, ${stateName}`
                    };
                }
                throw new Error(`ZIP code ${parsed.value} not found`);
            }
            
            if (parsed.type === 'city_state') {
                const url = `https://nominatim.openstreetmap.org/search?q=${parsed.city},${parsed.state},US&format=json&limit=1`;
                
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'FishCast/1.0' }
                });
                
                const data = await response.json();
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon),
                        name: `${parsed.city}, ${parsed.state}`
                    };
                }
                throw new Error(`Location "${parsed.city}, ${parsed.state}" not found. Please check spelling.`);
            }
            
            if (parsed.type === 'city_only') {
                const url = `https://nominatim.openstreetmap.org/search?q=${parsed.value},US&format=json&limit=1`;
                
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'FishCast/1.0' }
                });
                
                const data = await response.json();
                if (data && data.length > 0) {
                    const displayName = data[0].display_name;
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon),
                        name: displayName
                    };
                }
                throw new Error(`Location "${parsed.value}" not found. Try: "City, State" or ZIP code.`);
            }
            
            throw new Error('Invalid location format. Use "City, State" or ZIP code.');
        }

        async function getWeather(lat, lon, days) {
            const endDate = new Date().toISOString().split('T')[0];
            const startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            const historicalUrl = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${startDate}&end_date=${endDate}&daily=temperature_2m_mean&temperature_unit=fahrenheit&timezone=auto`;
            
            const historicalResponse = await fetch(historicalUrl);
            const historicalData = await historicalResponse.json();
            
            const forecastUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,relative_humidity_2m,surface_pressure,wind_speed_10m,wind_direction_10m,cloud_cover,weather_code&hourly=temperature_2m,surface_pressure,wind_speed_10m,wind_direction_10m,cloud_cover,weather_code,precipitation_probability,precipitation&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,precipitation_sum,sunrise,sunset&temperature_unit=fahrenheit&timezone=auto&forecast_days=${days}`;
            
            const forecastResponse = await fetch(forecastUrl);
            const forecastData = await forecastResponse.json();
            
            return { historical: historicalData, forecast: forecastData };
        }

        // ============================================
        // WATER TEMPERATURE & FISH BIOLOGY
        // ============================================
        
        function estimateWaterTemp(airTemps, waterType) {
            if (!airTemps || airTemps.length === 0) return 50;
            
            const body = WATER_BODIES[waterType];
            const lagDays = body.thermal_lag_days;
            const relevantTemps = airTemps.slice(-lagDays);
            
            let weightedSum = 0;
            let totalWeight = 0;
            
            relevantTemps.forEach((temp, i) => {
                const age = relevantTemps.length - i - 1;
                const weight = Math.pow(2, -age / 3);
                weightedSum += temp * weight;
                totalWeight += weight;
            });
            
            const weightedAvg = weightedSum / totalWeight;
            let waterTemp = weightedAvg * body.response_factor + 5.0;
            
            return Math.max(32, Math.min(95, waterTemp));
        }

        function getFishPhase(waterTemp, speciesData) {
            for (const [phaseName, phaseData] of Object.entries(speciesData.phases)) {
                const [min, max] = phaseData.temp_range;
                if (waterTemp >= min && waterTemp < max) {
                    return { name: phaseName, data: phaseData };
                }
            }
            const firstPhase = Object.keys(speciesData.phases)[0];
            return { name: firstPhase, data: speciesData.phases[firstPhase] };
        }

        function getPressureTrend(pressureList) {
            if (pressureList.length < 2) return 'stable';
            
            const change = pressureList[pressureList.length - 1] - pressureList[0];
            const hours = pressureList.length - 1;
            const rate = change / hours;
            
            if (rate < -2) return 'rapid_fall';
            if (rate < -0.5) return 'falling';
            if (rate > 2) return 'rapid_rise';
            if (rate > 0.5) return 'rising';
            return 'stable';
        }

        function calculateFishingScore(weather, waterTemp, speciesData, speciesKey) {
            let score = 50;
            const factors = [];
            const prefs = speciesData.preferences;
            
            const pressures = weather.hourly.surface_pressure.slice(0, 6);
            const pTrend = getPressureTrend(pressures);
            
            if (pTrend === 'rapid_fall') {
                const bonus = speciesKey === 'crappie' ? 40 : 35;
                score += bonus;
                factors.push({ name: 'Rapid pressure fall', value: bonus });
            } else if (pTrend === 'falling') {
                const bonus = speciesKey === 'crappie' ? 30 : 25;
                score += bonus;
                factors.push({ name: 'Falling pressure', value: bonus });
            } else if (pTrend === 'rising') {
                score -= 5;
                factors.push({ name: 'Rising pressure', value: -5 });
            }
            
            const phase = getFishPhase(waterTemp, speciesData);
            let phaseBonus = phase.data.score_bonus;
            
            if (waterTemp < 50) {
                phaseBonus -= 20;
                factors.push({ name: 'Winter cold override', value: -20 });
            }
            
            score += phaseBonus;
            factors.push({ name: phase.name.replace('_', ' ') + ' phase', value: phaseBonus });
            
            const windSpeed = kmhToMph(weather.current.wind_speed_10m);
            
            if (speciesKey === 'bass') {
                const windIdeal = prefs.wind_ideal || [5, 15];
                if (windSpeed >= windIdeal[0] && windSpeed <= windIdeal[1]) {
                    score += 15;
                } else if (windSpeed > 20) {
                    score -= 10;
                } else if (windSpeed > 15) {
                    score += 5;
                } else {
                    score += 5;
                }
            } else if (speciesKey === 'crappie') {
                if (windSpeed < 5) {
                    score += 15;
                } else if (windSpeed < 8) {
                    score += 5;
                } else if (windSpeed > 10) {
                    score -= 12;
                }
            } else {
                if (windSpeed < 12) {
                    score += 10;
                } else if (windSpeed > 15) {
                    score -= 10;
                }
            }
            
            const clouds = weather.current.cloud_cover;
            
            if (clouds >= 30 && clouds <= 70) {
                score += 10;
            } else if (clouds > 70) {
                if (speciesKey === 'crappie') {
                    score += 15;
                } else if (speciesKey === 'bass') {
                    score += 8;
                } else if (speciesKey === 'bluegill' && prefs.spawn_needs_sun && waterTemp >= 67 && waterTemp <= 74) {
                    score -= 5;
                }
            }
            
            const code = weather.current.weather_code;
            
            if (code === 51 || code === 53 || code === 61) {
                if (speciesKey === 'bass' && prefs.loves_light_rain) {
                    if (pTrend === 'falling' || pTrend === 'rapid_fall') {
                        score += 20;
                    } else {
                        score += 10;
                    }
                } else if (speciesKey === 'crappie') {
                    score += 5;
                }
            } else if (code === 45 || code === 48) {
                const bonus = speciesKey === 'crappie' ? 20 : 15;
                score += bonus;
            } else if (code === 95 || code === 96 || code === 99) {
                score -= 40;
            } else if (code === 63 || code === 65 || code === 80 || code === 81 || code === 82) {
                const penalty = speciesKey === 'crappie' ? -15 : -12;
                score += penalty;
            }
            
            const precipProb = weather.hourly.precipitation_probability[0] || 0;
            if (precipProb > 70 && code !== 51 && code !== 53 && code !== 61) {
                score -= 10;
            }
            
            score = Math.max(0, Math.min(100, Math.round(score)));
            
            let rating = 'BAD';
            let colorClass = 'bad';
            if (score >= 80) { rating = 'EXCELLENT'; colorClass = 'excellent'; }
            else if (score >= 65) { rating = 'GOOD'; colorClass = 'good'; }
            else if (score >= 50) { rating = 'FAIR'; colorClass = 'fair'; }
            else if (score >= 35) { rating = 'POOR'; colorClass = 'poor'; }
            
            return { score, rating, colorClass, factors, phase: phase.name };
        }

        // ============================================
        // FISHING TECHNIQUE TIPS
        // ============================================
        
        function getTechniqueTips(score, waterTemp, windSpeed, weather, speciesKey) {
            const tips = [];
            
            if (waterTemp < 50) {
                tips.push("üê¢ Fish are sluggish in cold water - use slow presentations and smaller baits");
                tips.push("üìç Target deeper water (15-25 ft) where fish are holding");
            } else if (waterTemp >= 58 && waterTemp <= 70) {
                tips.push("üéØ Pre-spawn/spawn period - fish are aggressive and shallow");
                tips.push("üèñÔ∏è Target shallow flats and spawning areas");
            }
            
            if (windSpeed < 5) {
                tips.push("ü§´ Calm conditions - use stealthy approaches and natural colors");
            } else if (windSpeed >= 10) {
                tips.push("üåä Wind creates current - fish the windward banks where food accumulates");
                tips.push("‚¨ÜÔ∏è Cast INTO the wind for better stealth");
            }
            
            const pTrend = getPressureTrend(weather.hourly.surface_pressure.slice(0, 6));
            if (pTrend === 'falling' || pTrend === 'rapid_fall') {
                tips.push("üìâ Falling pressure - fish are feeding aggressively before weather change!");
            }
            
            const code = weather.current.weather_code;
            if (code === 51 || code === 53 || code === 61) {
                if (speciesKey === 'bass') {
                    tips.push("üåßÔ∏è Light rain - topwater lures can be very effective!");
                }
            }
            
            if (score >= 80) {
                tips.push("üî• Excellent conditions - prime time for fishing!");
            } else if (score < 40) {
                tips.push("‚è≥ Tough conditions - focus on solunar major periods for best results");
            }
            
            return tips;
        }

        // ============================================
        // UI COMPONENTS
        // ============================================
        
        let currentLat, currentLon, currentForecastData;

        function showRadar(lat, lon) {
            currentLat = lat;
            currentLon = lon;
            setRadarLayer('radar');
            document.getElementById('radarSection').style.display = 'block';
        }

        function setRadarLayer(layer) {
            const frame = document.getElementById('radarFrame');
            const zoom = 8;
            
            const layerMap = {
                'radar': 'radar',
                'wind': 'wind',
                'temp': 'temp',
                'clouds': 'clouds'
            };
            
            document.querySelectorAll('.radar-controls button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const url = `https://embed.windy.com/embed2.html?lat=${currentLat}&lon=${currentLon}&detailLat=${currentLat}&detailLon=${currentLon}&width=650&height=450&zoom=${zoom}&level=surface&overlay=${layerMap[layer]}&product=ecmwf&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=mph&metricTemp=%C2%B0F&radarRange=-1`;
            
            frame.src = url;
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification-badge';
            notification.textContent = message;
            if (type === 'error') {
                notification.style.background = '#e74c3c';
            }
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ============================================
        // FAVORITES MANAGER
        // ============================================
        
        class FavoritesManager {
            constructor() {
                this.favorites = JSON.parse(localStorage.getItem('fishcast_favorites') || '[]');
                this.render();
            }
            
            add(name, location) {
                const favorite = {
                    id: Date.now(),
                    name: name,
                    location: location,
                    addedAt: new Date().toISOString()
                };
                
                this.favorites.push(favorite);
                this.save();
                this.render();
            }
            
            remove(id) {
                this.favorites = this.favorites.filter(f => f.id !== id);
                this.save();
                this.render();
            }
            
            save() {
                localStorage.setItem('fishcast_favorites', JSON.stringify(this.favorites));
            }
            
            render() {
                const section = document.getElementById('favoritesSection');
                const list = document.getElementById('favoritesList');
                
                if (this.favorites.length === 0) {
                    section.style.display = 'none';
                    return;
                }
                
                section.style.display = 'block';
                list.innerHTML = this.favorites.map(fav => `
                    <div class="favorite-item" onclick="favoritesManager.select('${fav.location}')">
                        <div>
                            <div class="favorite-name">${fav.name}</div>
                            <div class="favorite-location">${fav.location}</div>
                        </div>
                        <span class="favorite-remove" onclick="event.stopPropagation(); favoritesManager.remove(${fav.id})">‚úï</span>
                    </div>
                `).join('');
            }
            
            select(location) {
                document.getElementById('location').value = location;
            }
        }

        const favoritesManager = new FavoritesManager();

        // ============================================
        // CATCH LOG MANAGER
        // ============================================
        
        class CatchLogManager {
            constructor() {
                this.catches = JSON.parse(localStorage.getItem('fishcast_catches') || '[]');
            }
            
            add(catchData) {
                const catch_entry = {
                    id: Date.now(),
                    ...catchData,
                    timestamp: new Date().toISOString()
                };
                
                this.catches.unshift(catch_entry);
                this.save();
                return catch_entry;
            }
            
            remove(id) {
                this.catches = this.catches.filter(c => c.id !== id);
                this.save();
            }
            
            save() {
                localStorage.setItem('fishcast_catches', JSON.stringify(this.catches));
            }
            
            getRecent(limit = 10) {
                return this.catches.slice(0, limit);
            }
            
            getStats() {
                if (this.catches.length === 0) return null;
                
                const totalCatches = this.catches.reduce((sum, c) => sum + (c.count || 0), 0);
                const avgSize = this.catches
                    .filter(c => c.size > 0)
                    .reduce((sum, c) => sum + c.size, 0) / this.catches.filter(c => c.size > 0).length;
                
                return {
                    totalTrips: this.catches.length,
                    totalCatches: totalCatches,
                    avgSize: avgSize.toFixed(1)
                };
            }
        }

        const catchLogManager = new CatchLogManager();

        function openCatchLog() {
            document.getElementById('catchLogModal').classList.add('show');
            renderCatchHistory();
        }

        function closeCatchLog() {
            document.getElementById('catchLogModal').classList.remove('show');
        }

        function saveCatch() {
            const count = parseInt(document.getElementById('catchCount').value) || 0;
            const size = parseFloat(document.getElementById('catchSize').value) || 0;
            const notes = document.getElementById('catchNotes').value;
            
            if (count === 0 && size === 0) {
                alert('Please enter number of fish or size');
                return;
            }
            
            const location = document.getElementById('location').value;
            const species = document.getElementById('species').value;
            const scoreElement = document.querySelector('.score-display');
            const predictedScore = scoreElement ? parseInt(scoreElement.textContent) : null;
            
            catchLogManager.add({
                location: location,
                species: species,
                count: count,
                size: size,
                notes: notes,
                predictedScore: predictedScore
            });
            
            document.getElementById('catchCount').value = '';
            document.getElementById('catchSize').value = '';
            document.getElementById('catchNotes').value = '';
            
            renderCatchHistory();
            showNotification('Catch logged successfully!');
        }

        function renderCatchHistory() {
            const list = document.getElementById('catchList');
            const recent = catchLogManager.getRecent(5);
            
            if (recent.length === 0) {
                list.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No catches logged yet</p>';
                return;
            }
            
            list.innerHTML = recent.map(c => {
                const date = new Date(c.timestamp);
                const speciesName = SPECIES_DATA[c.species]?.name || c.species;
                return `
                    <div class="catch-item">
                        <div class="catch-info">
                            <div class="catch-species">${speciesName} at ${c.location}</div>
                            <div class="catch-details">
                                ${c.count} fish${c.size ? ` | ${c.size}" avg` : ''} | 
                                ${date.toLocaleDateString()}
                                ${c.notes ? ` | ${c.notes}` : ''}
                            </div>
                        </div>
                        <span class="catch-delete" onclick="catchLogManager.remove(${c.id}); renderCatchHistory();">‚úï</span>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // OFFLINE STORAGE
        // ============================================
        
        class OfflineManager {
            constructor() {
                this.dbName = 'FishCastDB';
                this.storeName = 'forecasts';
            }
            
            async saveForecast(forecastKey, data) {
                try {
                    localStorage.setItem(`forecast_${forecastKey}`, JSON.stringify({
                        data: data,
                        savedAt: new Date().toISOString()
                    }));
                } catch (e) {
                    console.error('Failed to save forecast offline:', e);
                }
            }
            
            async loadForecast(forecastKey) {
                try {
                    const stored = localStorage.getItem(`forecast_${forecastKey}`);
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        const savedAt = new Date(parsed.savedAt);
                        const hoursSince = (Date.now() - savedAt.getTime()) / (1000 * 60 * 60);
                        
                        if (hoursSince < 24) {
                            return parsed.data;
                        }
                    }
                } catch (e) {
                    console.error('Failed to load offline forecast:', e);
                }
                return null;
            }
        }

        const offlineManager = new OfflineManager();

        let dayForecastDetails = [];


        // ============================================
        // MAIN FORECAST GENERATION
        // ============================================
        
        async function generateForecast(location, speciesKey, waterType, days) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing conditions...</p></div>';
            
            try {
                const coords = await getLocation(location);
                const { historical, forecast } = await getWeather(coords.lat, coords.lon, days);
                
                currentForecastData = { coords, forecast, historical, location, speciesKey, waterType, days };
                
                const forecastKey = `${coords.lat}_${coords.lon}_${speciesKey}_${waterType}`;
                await offlineManager.saveForecast(forecastKey, currentForecastData);
                
                const historicalTemps = historical.daily.temperature_2m_mean; // value is already ¬∞F from weatherAPI
                const currentWaterTemp = estimateWaterTemp(historicalTemps, waterType);
                
                const speciesData = SPECIES_DATA[speciesKey];
                const currentScore = calculateFishingScore(forecast, currentWaterTemp, speciesData, speciesKey);
                
                const today = new Date();
                const solunar = calculateSolunar(coords.lat, coords.lon, today);
                
                const tips = getTechniqueTips(
                    currentScore.score,
                    currentWaterTemp,
                    kmhToMph(forecast.current.wind_speed_10m),
                    forecast,
                    speciesKey
                );
                
                dayForecastDetails = [];

                let html = `
                    <div class="score-header">
                        <h2>Today's Forecast</h2>
                        <div class="score-display ${currentScore.colorClass}">${currentScore.score}</div>
                        <div class="rating ${currentScore.colorClass}">${currentScore.rating}</div>
                        <div class="location-info">
                            ${coords.name} | ${speciesData.name}
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn primary" onclick="openCatchLog()">üìä Log Catch</button>
                        <button class="action-btn" onclick="shareF()">üì± Share</button>
                        <button class="action-btn" onclick="saveFavorite()">‚≠ê Save Location</button>
                    </div>
                    
                    <div class="tips-card">
                        <h3>üé£ Fishing Tips for Today</h3>
                        ${tips.map(tip => `<div class="tip-item">${tip}</div>`).join('')}
                    </div>
                    
                    <div class="details-grid">
                        <div class="detail-card">
                            <h3>Water Conditions</h3>
                            <div class="detail-row">
                                <span class="detail-label">Water Temperature</span>
                                <span class="detail-value">${currentWaterTemp.toFixed(1)}¬∞F</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Air Temperature</span>
                                <span class="detail-value">${forecast.current.temperature_2m.toFixed(1)}¬∞F (feels like ${forecast.current.apparent_temperature.toFixed(1)}¬∞F)</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Fish Phase</span>
                                <span class="detail-value">${currentScore.phase.replace('_', ' ')}</span>
                            </div>
                        </div>
                        
                        <div class="detail-card">
                            <h3>Weather</h3>
                            <div class="detail-row">
                                <span class="detail-label">Pressure</span>
                                <span class="detail-value">${forecast.current.surface_pressure} mb (${(forecast.current.surface_pressure * 0.02953).toFixed(2)} inHg)</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Pressure Trend</span>
                                <span class="detail-value">${getPressureTrend(forecast.hourly.surface_pressure.slice(0, 6)).replace('_', ' ').toUpperCase()}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Wind</span>
                                <span class="detail-value">${kmhToMph(forecast.current.wind_speed_10m).toFixed(1)} mph ${getWindDirection(forecast.current.wind_direction_10m)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Hourly Wind</span>
                                <span class="detail-value">${kmhToMph(forecast.hourly.wind_speed_10m[0] || 0).toFixed(1)} mph ${getWindDirection(forecast.hourly.wind_direction_10m[0] || 0)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Humidity</span>
                                <span class="detail-value">${forecast.current.relative_humidity_2m}%</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Cloud Cover</span>
                                <span class="detail-value">${forecast.current.cloud_cover}%</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Precipitation Possible</span>
                                <span class="detail-value">${forecast.hourly.precipitation_probability[0] || 0}% chance (${mmToIn(forecast.hourly.precipitation[0] || 0).toFixed(2)} in)</span>
                            </div>
                        </div>
                        
                        <div class="detail-card">
                            <h3>Solunar Times</h3>
                            <div class="detail-row">
                                <span class="detail-label">Moon Phase</span>
                                <span class="detail-value">${solunar.moon_phase} (${solunar.illumination.toFixed(0)}% illuminated)</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Sunrise</span>
                                <span class="detail-value">${formatTime(forecast.daily.sunrise[0])}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Sunset</span>
                                <span class="detail-value">${formatTime(forecast.daily.sunset[0])}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Major Periods</span>
                                <span class="detail-value">${solunar.major_periods[0]}, ${solunar.major_periods[1]}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Minor Periods</span>
                                <span class="detail-value">${solunar.minor_periods[0]}, ${solunar.minor_periods[1]}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="calendar-view">
                        <h3>üìÖ Week at a Glance</h3>
                        <div class="calendar-grid" id="calendarGrid"></div>
                    </div>
                    
                    <div class="radar-section" id="radarSection" style="display: none;">
                        <h3>üó∫Ô∏è Weather Radar</h3>
                        <div class="radar-controls">
                            <button onclick="setRadarLayer('radar')" class="active">Radar</button>
                            <button onclick="setRadarLayer('wind')">Wind</button>
                            <button onclick="setRadarLayer('temp')">Temperature</button>
                            <button onclick="setRadarLayer('clouds')">Clouds</button>
                        </div>
                        <iframe id="radarFrame" width="100%" height="450" frameborder="0" style="border-radius: 2px;"></iframe>
                    </div>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <button class="action-btn" onclick="showRadar(${coords.lat}, ${coords.lon})" style="width: auto;">
                            üó∫Ô∏è Show Weather Radar
                        </button>
                    </div>
                    
                    <div class="forecast-grid">
                `;
                
                const allDailyScores = [];
                
                for (let i = 1; i < forecast.daily.time.length; i++) {
                    const date = forecast.daily.time[i];
                    
                    const futureAirTemps = [...historicalTemps];
                    for (let j = 1; j <= i; j++) {
                        const futureAvg = (forecast.daily.temperature_2m_max[j] + forecast.daily.temperature_2m_min[j]) / 2; // value is already ¬∞F from weatherAPI
                        futureAirTemps.push(futureAvg);
                    }
                    const dayWaterTemp = estimateWaterTemp(futureAirTemps, waterType);
                    
                    const hourIndex = i * 24 + 12;
                    const safeHourIndex = Math.min(hourIndex, forecast.hourly.cloud_cover.length - 1);
                    
                    const dayWeather = {
                        current: {
                            temperature_2m: forecast.daily.temperature_2m_max[i],
                            cloud_cover: forecast.hourly.cloud_cover[safeHourIndex] || 50,
                            wind_speed_10m: forecast.hourly.wind_speed_10m[safeHourIndex] || 0,
                            weather_code: forecast.hourly.weather_code[safeHourIndex] || 0
                        },
                        hourly: {
                            surface_pressure: forecast.hourly.surface_pressure.slice(
                                Math.max(0, safeHourIndex - 6),
                                safeHourIndex
                            ),
                            precipitation_probability: [forecast.hourly.precipitation_probability[safeHourIndex] || 0]
                        }
                    };
                    
                    const dayScore = calculateFishingScore(dayWeather, dayWaterTemp, speciesData, speciesKey);
                    const windSpeed = kmhToMph(dayWeather.current.wind_speed_10m);
                    const windDir = getWindDirection(forecast.hourly.wind_direction_10m[safeHourIndex] || 0);
                    const precip = forecast.daily.precipitation_probability_max[i] || 0;
                    const precipAmountIn = mmToIn(forecast.daily.precipitation_sum?.[i] || 0);
                    const pressure = dayWeather.hourly.surface_pressure[0] || forecast.current.surface_pressure;
                    const pressureTrend = getPressureTrend(dayWeather.hourly.surface_pressure);
                    const clouds = dayWeather.current.cloud_cover;
                    
                    const futureDate = new Date(date + 'T12:00:00');
                    const daySolunar = calculateSolunar(coords.lat, coords.lon, futureDate);
                    
                    const moonIcon = getMoonPhaseIcon(daySolunar.moon_phase);
                    const dayDateLabel = formatDate(date);

                    allDailyScores.push({
                        date: date,
                        score: dayScore.score,
                        rating: dayScore.rating,
                        colorClass: dayScore.colorClass
                    });

                    dayForecastDetails.push({
                        date: date,
                        dateLabel: dayDateLabel,
                        score: dayScore.score,
                        rating: dayScore.rating,
                        colorClass: dayScore.colorClass,
                        waterTemp: `${dayWaterTemp.toFixed(1)}¬∞F`,
                        airTemp: `${forecast.daily.temperature_2m_max[i].toFixed(0)}¬∞ / ${forecast.daily.temperature_2m_min[i].toFixed(0)}¬∞F`,
                        wind: `${windSpeed.toFixed(1)} mph ${windDir}`,
                        pressure: `${(pressure * 0.02953).toFixed(2)} inHg (${pressureTrend.replace('_', ' ')})`,
                        clouds: `${clouds}%`,
                        precip: `${precip}% (${precipAmountIn.toFixed(2)} in)`,
                        sunriseSunset: `${formatTime(forecast.daily.sunrise[i])} / ${formatTime(forecast.daily.sunset[i])}`,
                        fishPhase: dayScore.phase.replace('_', ' '),
                        solunar: {
                            moonIcon: moonIcon,
                            moonPhase: daySolunar.moon_phase,
                            illumination: `${daySolunar.illumination.toFixed(0)}%`,
                            majorPeriods: daySolunar.major_periods,
                            minorPeriods: daySolunar.minor_periods
                        }
                    });
                    
                    html += `
                        <div class="day-card" onclick="openDayDetails('${date}')" role="button" tabindex="0" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openDayDetails('${date}');}">
                            <div class="day-header">${dayDateLabel}</div>
                            <div class="day-score ${dayScore.colorClass}">${dayScore.score}</div>
                            <div class="day-rating ${dayScore.colorClass}">${dayScore.rating}</div>
                            <div class="weather-detail">
                                <span class="weather-label">Water Temp</span>
                                <span class="weather-value">${dayWaterTemp.toFixed(1)}¬∞F</span>
                            </div>
                            <div class="weather-detail">
                                <span class="weather-label">Air Temp</span>
                                <span class="weather-value">${forecast.daily.temperature_2m_max[i].toFixed(0)}¬∞ / ${forecast.daily.temperature_2m_min[i].toFixed(0)}¬∞F</span>
                            </div>
                            <div class="weather-detail">
                                <span class="weather-label">Wind</span>
                                <span class="weather-value">${windSpeed.toFixed(1)} mph ${windDir}</span>
                            </div>
                            <div class="weather-detail">
                                <span class="weather-label">Pressure</span>
                                <span class="weather-value">${(pressure * 0.02953).toFixed(2)} inHg (${pressureTrend.replace('_', ' ')})</span>
                            </div>
                            <div class="weather-detail">
                                <span class="weather-label">Clouds</span>
                                <span class="weather-value">${clouds}%</span>
                            </div>
                            <div class="weather-detail">
                                <span class="weather-label">Precip</span>
                                <span class="weather-value">${precip}% (${precipAmountIn.toFixed(2)} in)</span>
                            </div>
                            <div class="weather-detail">
                                <span class="weather-label">Fish Phase</span>
                                <span class="weather-value">${dayScore.phase.replace('_', ' ')}</span>
                            </div>
                            <div class="solunar-preview">
                                <div class="weather-detail">
                                    <span class="weather-label">Solunar (Preview)</span>
                                    <span class="weather-value">${moonIcon} ${daySolunar.moon_phase}</span>
                                </div>
                                <div class="weather-detail">
                                    <span class="weather-label">Major</span>
                                    <span class="weather-value">${daySolunar.major_periods[0]}</span>
                                </div>
                                <div class="weather-detail">
                                    <span class="weather-label">Minor</span>
                                    <span class="weather-value">${daySolunar.minor_periods[0]}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                resultsDiv.innerHTML = html;
                
                const calendarGrid = document.getElementById('calendarGrid');
                calendarGrid.innerHTML = [
                    { date: forecast.daily.time[0], score: currentScore.score, rating: currentScore.rating, colorClass: currentScore.colorClass },
                    ...allDailyScores
                ].map(day => `
                    <div class="calendar-day" style="background: var(--bg-secondary);">
                        <div class="calendar-day-name">${formatDateShort(day.date)}</div>
                        <div class="calendar-day-score ${day.colorClass}">${day.score}</div>
                        <div class="calendar-day-rating ${day.colorClass}">${day.rating}</div>
                    </div>
                `).join('');
                
                resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                

                
            } catch (error) {
                console.error('Error:', error);
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>Error</h3>
                        <p>${error.message || 'Could not generate forecast. Please try again.'}</p>
                    </div>
                `;
            }
        }

        // ============================================
        // SOCIAL SHARING
        // ============================================
        
        function shareForecast() {
            const location = document.getElementById('location').value;
            const species = document.getElementById('species').options[document.getElementById('species').selectedIndex].text;
            const scoreElement = document.querySelector('.score-display');
            const ratingElement = document.querySelector('.rating');
            
            if (!scoreElement) return;
            
            const score = scoreElement.textContent;
            const rating = ratingElement.textContent;
            
            const shareData = {
                title: 'FishCast Fishing Forecast',
                text: `üé£ ${species} fishing at ${location}:\nScore: ${score}/100 (${rating})\n\nCheck it out on FishCast!`,
                url: window.location.href
            };
            
            if (navigator.share) {
                navigator.share(shareData).catch(() => {});
            } else {
                const text = `${shareData.text}\n${shareData.url}`;
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('Forecast copied to clipboard!');
                });
            }
        }

        function saveFavorite() {
            const location = document.getElementById('location').value;
            const name = prompt('Name this fishing spot:', location);
            
            if (name) {
                favoritesManager.add(name, location);
                showNotification('Saved to favorites!');
            }
        }

        // ============================================
        // PUSH NOTIFICATIONS
        // ============================================
        


        // ============================================
        // EVENT LISTENERS & INITIALIZATION
        // ============================================
        
        const daysSlider = document.getElementById('days');
        const daysValue = document.getElementById('daysValue');
        daysSlider.addEventListener('input', (e) => {
            daysValue.textContent = e.target.value;
        });

        const locationInput = document.getElementById('location');
        let validationTimeout;
        
        locationInput.addEventListener('input', (e) => {
            const value = e.target.value.trim();
            
            clearTimeout(validationTimeout);
            locationInput.classList.remove('valid', 'invalid', 'validating');
            
            if (value.length < 2) return;
            
            locationInput.classList.add('validating');
            
            validationTimeout = setTimeout(() => {
                const parsed = parseLocation(value);
                
                if (parsed.type === 'zip' || parsed.type === 'city_state') {
                    locationInput.classList.remove('validating', 'invalid');
                    locationInput.classList.add('valid');
                } else if (parsed.type === 'city_only') {
                    locationInput.classList.remove('validating');
                } else {
                    locationInput.classList.remove('validating', 'valid');
                    locationInput.classList.add('invalid');
                }
            }, 500);
        });

        document.getElementById('geolocateBtn').addEventListener('click', async () => {
            const btn = document.getElementById('geolocateBtn');
            const locationInput = document.getElementById('location');
            
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = '‚è≥';
            
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    try {
                        const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`;
                        const response = await fetch(url, {
                            headers: { 'User-Agent': 'FishCast/1.0' }
                        });
                        const data = await response.json();
                        
                        const city = data.address.city || data.address.town || data.address.village;
                        const state = data.address.state;
                        
                        locationInput.value = `${city}, ${state}`;
                        btn.textContent = '‚úì';
                        setTimeout(() => {
                            btn.textContent = 'üìç';
                            btn.disabled = false;
                        }, 2000);
                    } catch (error) {
                        alert('Could not determine location name');
                        btn.textContent = 'üìç';
                        btn.disabled = false;
                    }
                },
                (error) => {
                    alert('Unable to get your location. Please enter manually.');
                    btn.textContent = 'üìç';
                    btn.disabled = false;
                }
            );
        });

        document.getElementById('forecastForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const location = document.getElementById('location').value;
            const species = document.getElementById('species').value;
            const waterType = document.getElementById('waterType').value;
            const days = parseInt(document.getElementById('days').value);
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Generating...';
            
            await generateForecast(location, species, waterType, days);
            
            submitBtn.disabled = false;
            submitBtn.textContent = 'Generate Forecast';
        });

        const themeToggle = document.getElementById('themeToggle');
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        const THEME_STORAGE_KEY = 'themePreference';
        const LEGACY_THEME_KEY = 'theme';
        const THEME_COOKIE_KEY = 'fishcast_theme';

        function getThemeFromCookie() {
            const cookie = document.cookie
                .split('; ')
                .find((part) => part.startsWith(`${THEME_COOKIE_KEY}=`));
            return cookie ? decodeURIComponent(cookie.split('=')[1]) : null;
        }

        function persistTheme(preference) {
            try {
                localStorage.setItem(THEME_STORAGE_KEY, preference);
                localStorage.setItem(LEGACY_THEME_KEY, preference);
            } catch (error) {
                // localStorage can be unavailable in some iOS standalone privacy configurations.
            }

            document.cookie = `${THEME_COOKIE_KEY}=${encodeURIComponent(preference)}; path=/; max-age=31536000; SameSite=Lax`;
        }

        function readThemePreference() {
            try {
                return (
                    localStorage.getItem(THEME_STORAGE_KEY) ||
                    localStorage.getItem(LEGACY_THEME_KEY) ||
                    getThemeFromCookie() ||
                    'system'
                );
            } catch (error) {
                return getThemeFromCookie() || 'system';
            }
        }

        let themePreference = readThemePreference();

        function getResolvedTheme(preference) {
            if (preference === 'system') {
                return prefersDarkScheme.matches ? 'dark' : 'light';
            }
            return preference;
        }

        function applyTheme(preference) {
            const resolvedTheme = getResolvedTheme(preference);
            document.documentElement.setAttribute('data-theme', resolvedTheme);
            themeToggle.textContent = resolvedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            themeToggle.title = preference === 'system'
                ? `Using system theme (${resolvedTheme}). Click to override manually.`
                : `Theme: ${resolvedTheme}. Click to toggle light/dark.`;
        }

        applyTheme(themePreference);

        prefersDarkScheme.addEventListener('change', () => {
            if (themePreference === 'system') {
                applyTheme(themePreference);
            }
        });

        themeToggle.addEventListener('click', () => {
            const current = getResolvedTheme(themePreference);
            const next = current === 'dark' ? 'light' : 'dark';
            themePreference = next;

            document.documentElement.setAttribute('data-theme', next);
            persistTheme(next);
            themeToggle.textContent = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            themeToggle.title = `Theme: ${next}. Click to toggle light/dark.`;
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }

        window.shareF = shareForecast;

        // Water Temp Report Functions

        function openTempReport() {
            // Set current date/time as default
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const dateTimeLocal = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            document.getElementById('reportDateTime').value = dateTimeLocal;
            document.getElementById('tempReportModal').classList.add('show');
        }

        function closeTempReport() {
            document.getElementById('tempReportModal').classList.remove('show');
            document.getElementById('tempReportForm').reset();
        }

        async function submitTempReport(event) {
            event.preventDefault();
            
            const location = document.getElementById('reportLocation').value;
            const dateTime = document.getElementById('reportDateTime').value;
            const temp = document.getElementById('reportTemp').value;
            const waterBody = document.getElementById('reportWaterBody').value;
            const depth = document.getElementById('reportDepth').value;
            const notes = document.getElementById('reportNotes').value;
            
            if (!location || !dateTime || !temp || !waterBody) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Geocode the location
            let coords = { lat: 0, lon: 0 };
            try {
                const geoData = await getLocation(location);
                coords.lat = geoData.lat;
                coords.lon = geoData.lon;
            } catch (error) {
                console.error('Geocoding failed:', error);
                alert('Could not find location. Please check your entry and try again.');
                return;
            }
            
            const WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbySp_91L4EPOFXFx2528Q7TPfRtQi9dBiR4l2CSWpnrJ_x2UdZGamdiqsS7bYOQ38R8bg/exec';
            
            const data = {
                timestamp: new Date(dateTime).toISOString(),
                location: location,
                latitude: coords.lat,
                longitude: coords.lon,
                waterBody: waterBody,
                temperature: parseFloat(temp),
                depth: depth ? parseInt(depth) : '',
                notes: notes,
                userAgent: navigator.userAgent
            };
            
            try {
                // Show submitting state
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'üì§ Submitting...';
                submitBtn.disabled = true;
                
                await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                // Success
                showNotification('Thank you! Your water temperature report helps improve accuracy for all anglers.', 'success');
                closeTempReport();
                
                // Reset button
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                
            } catch (error) {
                console.error('Error submitting report:', error);
                showNotification('Could not submit report. Please check your internet connection and try again.', 'error');
                
                // Reset button
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.textContent = 'üì§ Submit Report';
                submitBtn.disabled = false;
            }
        }

        // Store forecast data globally for water temp reporting
        window.currentForecastData = null;

        function openDayDetails(dateStr) {
            const details = dayForecastDetails.find(day => day.date === dateStr);
            if (!details) return;

            document.getElementById('dayDetailsTitle').textContent = `üìÖ ${details.dateLabel} Details`;
            document.getElementById('dayDetailsContent').innerHTML = `
                <div class="day-details-grid">
                    <div class="day-details-item">
                        <div class="day-details-item-label">Fishing Score</div>
                        <div class="day-details-item-value ${details.colorClass}">${details.score} (${details.rating})</div>
                    </div>
                    <div class="day-details-item">
                        <div class="day-details-item-label">Water Temp</div>
                        <div class="day-details-item-value">${details.waterTemp}</div>
                    </div>
                    <div class="day-details-item">
                        <div class="day-details-item-label">Air Temp</div>
                        <div class="day-details-item-value">${details.airTemp}</div>
                    </div>
                    <div class="day-details-item">
                        <div class="day-details-item-label">Wind</div>
                        <div class="day-details-item-value">${details.wind}</div>
                    </div>
                    <div class="day-details-item">
                        <div class="day-details-item-label">Pressure</div>
                        <div class="day-details-item-value">${details.pressure}</div>
                    </div>
                    <div class="day-details-item">
                        <div class="day-details-item-label">Clouds / Precip</div>
                        <div class="day-details-item-value">${details.clouds} / ${details.precip}</div>
                    </div>
                    <div class="day-details-item">
                        <div class="day-details-item-label">Sunrise / Sunset</div>
                        <div class="day-details-item-value">${details.sunriseSunset}</div>
                    </div>
                    <div class="day-details-item">
                        <div class="day-details-item-label">Fish Phase</div>
                        <div class="day-details-item-value">${details.fishPhase}</div>
                    </div>
                </div>
                <div class="solunar-preview" style="margin-top: 16px;">
                    <div style="font-family: 'Cinzel', serif; font-weight: 700; margin-bottom: 10px;">üåô Full Solunar Data</div>
                    <div class="day-details-grid" style="margin-top: 0;">
                        <div class="day-details-item">
                            <div class="day-details-item-label">Moon Phase</div>
                            <div class="day-details-item-value">${details.solunar.moonIcon} ${details.solunar.moonPhase} (${details.solunar.illumination})</div>
                        </div>
                        <div class="day-details-item">
                            <div class="day-details-item-label">Major Period 1</div>
                            <div class="day-details-item-value">${details.solunar.majorPeriods[0]}</div>
                        </div>
                        <div class="day-details-item">
                            <div class="day-details-item-label">Major Period 2</div>
                            <div class="day-details-item-value">${details.solunar.majorPeriods[1]}</div>
                        </div>
                        <div class="day-details-item">
                            <div class="day-details-item-label">Minor Period 1</div>
                            <div class="day-details-item-value">${details.solunar.minorPeriods[0]}</div>
                        </div>
                        <div class="day-details-item">
                            <div class="day-details-item-label">Minor Period 2</div>
                            <div class="day-details-item-value">${details.solunar.minorPeriods[1]}</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('dayDetailsModal').classList.add('show');
        }

        function closeDayDetails() {
            document.getElementById('dayDetailsModal').classList.remove('show');
        }

        // Settings Modal Functions
        function openSettings() {
            document.getElementById('settingsModal').classList.add('show');
            loadSettings();
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function loadSettings() {
            // Load defaults
            document.getElementById('defaultLocation').value = localStorage.getItem('default_location') || '';
            document.getElementById('defaultSpecies').value = localStorage.getItem('default_species') || '';
            document.getElementById('defaultWaterBody').value = localStorage.getItem('default_water_body') || '';
        }

        function saveSettings() {
            // Save defaults
            localStorage.setItem('default_location', document.getElementById('defaultLocation').value);
            localStorage.setItem('default_species', document.getElementById('defaultSpecies').value);
            localStorage.setItem('default_water_body', document.getElementById('defaultWaterBody').value);
            
            showNotification('Settings saved!');
            
            // Apply defaults to form if empty
            const locationInput = document.getElementById('location');
            if (!locationInput.value && localStorage.getItem('default_location')) {
                locationInput.value = localStorage.getItem('default_location');
            }
            
            const speciesSelect = document.getElementById('species');
            if (localStorage.getItem('default_species')) {
                speciesSelect.value = localStorage.getItem('default_species');
            }
            
            const waterTypeSelect = document.getElementById('waterType');
            if (localStorage.getItem('default_water_body')) {
                waterTypeSelect.value = localStorage.getItem('default_water_body');
            }
            
            closeSettings();
        }

        function exportAllData() {
            const data = {
                favorites: JSON.parse(localStorage.getItem('fishcast_favorites') || '[]'),
                catches: JSON.parse(localStorage.getItem('fishcast_catches') || '[]'),
                settings: {
                    theme: localStorage.getItem('themePreference') || localStorage.getItem('theme') || 'system',
                    default_location: localStorage.getItem('default_location') || '',
                    default_species: localStorage.getItem('default_species') || '',
                    default_water_body: localStorage.getItem('default_water_body') || '',
                    notifications_enabled: localStorage.getItem('notifications_enabled') || 'false'
                },
                exported_at: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fishcast-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showNotification('Data exported successfully!');
        }

        function clearAllData() {
            if (!confirm('Are you sure you want to delete ALL data? This includes favorites, catches, and settings. This cannot be undone!')) {
                return;
            }

            if (!confirm('Really sure? This will permanently delete everything!')) {
                return;
            }

            localStorage.removeItem('fishcast_favorites');
            localStorage.removeItem('fishcast_catches');
            localStorage.removeItem('default_location');
            localStorage.removeItem('default_species');
            localStorage.removeItem('default_water_body');
            localStorage.removeItem('notifications_enabled');

            showNotification('All data cleared!', 'error');
            
            // Reload managers
            favoritesManager.favorites = [];
            favoritesManager.render();
            
            closeSettings();
        }

        // About Modal Functions
        function openAbout() {
            document.getElementById('aboutModal').classList.add('show');
        }

        function closeAbout() {
            document.getElementById('aboutModal').classList.remove('show');
        }

        // Link event listeners
        document.getElementById('settingsLink').addEventListener('click', (e) => {
            e.preventDefault();
            openSettings();
        });

        document.getElementById('aboutLink').addEventListener('click', (e) => {
            e.preventDefault();
            openAbout();
        });

        // Load defaults on page load
        window.addEventListener('load', () => {
            const defaultLocation = localStorage.getItem('default_location');
            const defaultSpecies = localStorage.getItem('default_species');
            const defaultWaterBody = localStorage.getItem('default_water_body');

            if (defaultLocation) {
                document.getElementById('location').value = defaultLocation;
            }
            if (defaultSpecies) {
                document.getElementById('species').value = defaultSpecies;
            }
            if (defaultWaterBody) {
                document.getElementById('waterType').value = defaultWaterBody;
            }
        });
    </script>
</body>
</html>
