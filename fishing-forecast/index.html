<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Smart fishing forecast with species-specific predictions, water temperature modeling, and solunar calculations.">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FishCast">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>FishCast - Smart Fishing Forecasts</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Lato', sans-serif;
            background: #f5f5f5;
            color: #2c3e50;
            line-height: 1.6;
        }
        
        /* Subtle fish pattern background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(52, 152, 219, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(46, 204, 113, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(52, 152, 219, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        header {
            text-align: center;
            padding: 60px 20px 40px;
        }
        
        .logo-text {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            font-weight: 700;
            color: #2c3e50;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 0.9rem;
            letter-spacing: 4px;
            text-transform: uppercase;
            color: #7f8c8d;
            font-weight: 300;
        }
        
        .form-card {
            background: white;
            border-radius: 2px;
            padding: 40px;
            margin: 40px auto;
            max-width: 600px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        input, select {
            width: 100%;
            padding: 12px 16px;
            font-size: 1rem;
            font-family: 'Lato', sans-serif;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 2px;
            transition: all 0.2s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            background: white;
        }
        
        input.validating {
            border-color: #f39c12;
            background: #fffbf0;
        }
        
        input.valid {
            border-color: #27ae60;
        }
        
        input.invalid {
            border-color: #e74c3c;
        }
        
        small {
            display: block;
            margin-top: 5px;
            font-size: 0.85rem;
            color: #7f8c8d;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
            color: #3498db;
        }
        
        input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 2px;
            background: #e0e0e0;
            border: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #3498db;
            cursor: pointer;
            border-radius: 50%;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #3498db;
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }
        
        button {
            width: 100%;
            padding: 16px;
            font-size: 0.9rem;
            font-family: 'Lato', sans-serif;
            font-weight: 700;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #34495e;
        }
        
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .score-header {
            background: white;
            border-radius: 2px;
            padding: 50px 30px;
            margin: 40px auto;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .score-header h2 {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 30px;
            color: #2c3e50;
            letter-spacing: 1px;
        }
        
        .score-display {
            font-family: 'Cinzel', serif;
            font-size: 6rem;
            font-weight: 700;
            line-height: 1;
            margin: 20px 0;
        }
        
        .rating {
            font-size: 1.5rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin: 15px 0;
        }
        
        .location-info {
            font-size: 1rem;
            color: #7f8c8d;
            margin-top: 20px;
        }
        
        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .day-card {
            background: white;
            border-radius: 2px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        
        .day-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .day-header {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
        }
        
        .day-score {
            font-size: 3.5rem;
            font-weight: 700;
            font-family: 'Cinzel', serif;
            text-align: center;
            margin: 15px 0;
        }
        
        .day-rating {
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .weather-detail {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 0.9rem;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .weather-detail:last-child {
            border-bottom: none;
        }
        
        .weather-label {
            color: #7f8c8d;
            font-weight: 400;
        }
        
        .weather-value {
            font-weight: 700;
            color: #2c3e50;
        }
        
        .error {
            background: #fff5f5;
            border: 2px solid #e74c3c;
            border-radius: 2px;
            padding: 25px;
            margin: 40px auto;
            max-width: 600px;
            text-align: center;
            color: #c0392b;
        }
        
        .error h3 {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #e74c3c;
        }
        
        .error p {
            margin: 10px 0;
            line-height: 1.6;
        }
        
        .error .hint {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f5c6cb;
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        footer {
            text-align: center;
            padding: 40px 20px;
            color: #95a5a6;
            font-size: 0.85rem;
        }
        
        /* Color classes */
        .excellent { color: #27ae60; }
        .good { color: #2ecc71; }
        .fair { color: #f39c12; }
        .poor { color: #e67e22; }
        .bad { color: #e74c3c; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-text">FishCast</div>
            <div class="subtitle">Fishing Forecast</div>
        </header>

        <div class="form-card">
            <form id="forecastForm">
                <div class="form-group">
                    <label for="location">Location</label>
                    <input 
                        type="text" 
                        id="location" 
                        placeholder="City, State (e.g., Tupelo, MS) or ZIP code"
                        required
                    >
                    <small style="color: #7f8c8d; font-size: 0.85rem; margin-top: 5px; display: block;">
                        Examples: "Tupelo, MS" or "Memphis TN" or "38801"
                    </small>
                </div>

                <div class="form-group">
                    <label for="species">Target Species</label>
                    <select id="species" required>
                        <option value="bass">Largemouth Bass</option>
                        <option value="crappie">Crappie</option>
                        <option value="bluegill">Bluegill</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="waterType">Water Body Type</label>
                    <select id="waterType" required>
                        <option value="lake">Lake (10-500 acres)</option>
                        <option value="pond">Pond (< 10 acres)</option>
                        <option value="reservoir">Reservoir (> 500 acres)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="days">Forecast Days</label>
                    <div class="slider-container">
                        <input 
                            type="range" 
                            id="days" 
                            min="3" 
                            max="10" 
                            value="7"
                            step="1"
                        >
                        <span class="slider-value" id="daysValue">7</span>
                    </div>
                </div>

                <button type="submit" id="submitBtn">
                    Generate Forecast
                </button>
            </form>
        </div>

        <div id="results"></div>

        <footer>
            <p>FishCast | Weather data from Open-Meteo</p>
        </footer>
    </div>

    <script>
        // Update slider
        const daysSlider = document.getElementById('days');
        const daysValue = document.getElementById('daysValue');
        daysSlider.addEventListener('input', (e) => {
            daysValue.textContent = e.target.value;
        });

        // Add location input validation
        const locationInput = document.getElementById('location');
        let validationTimeout;
        
        locationInput.addEventListener('input', (e) => {
            const value = e.target.value.trim();
            
            // Clear previous timeout
            clearTimeout(validationTimeout);
            
            // Remove all validation classes
            locationInput.classList.remove('valid', 'invalid', 'validating');
            
            if (value.length < 2) return;
            
            // Show validating state
            locationInput.classList.add('validating');
            
            // Debounce validation
            validationTimeout = setTimeout(() => {
                const parsed = parseLocation(value);
                
                // Visual feedback based on parse result
                if (parsed.type === 'zip' || parsed.type === 'city_state') {
                    locationInput.classList.remove('validating', 'invalid');
                    locationInput.classList.add('valid');
                } else if (parsed.type === 'city_only') {
                    locationInput.classList.remove('validating');
                    // Neutral - might work
                } else {
                    locationInput.classList.remove('validating', 'valid');
                    locationInput.classList.add('invalid');
                }
            }, 500);
        });

        // Species data - EXACT from species.yaml
        const SPECIES_DATA = {
            bass: {
                name: "Largemouth Bass",
                phases: {
                    winter: { temp_range: [35, 48], score_bonus: -10 },
                    pre_spawn: { temp_range: [48, 58], score_bonus: 20 },
                    spawn: { temp_range: [58, 70], score_bonus: 30 },
                    post_spawn: { temp_range: [70, 75], score_bonus: -5 },
                    early_summer: { temp_range: [75, 80], score_bonus: 18 },
                    summer: { temp_range: [80, 88], score_bonus: 12 },
                    fall: { temp_range: [58, 72], score_bonus: 25 }
                },
                preferences: {
                    wind_ideal: [5, 15],
                    loves_light_rain: true,
                    overcast_bonus: 8
                }
            },
            crappie: {
                name: "Crappie",
                phases: {
                    winter: { temp_range: [32, 45], score_bonus: -5 },
                    pre_spawn: { temp_range: [45, 55], score_bonus: 15 },
                    spawn: { temp_range: [55, 65], score_bonus: 30 },
                    post_spawn: { temp_range: [65, 70], score_bonus: 5 },
                    summer: { temp_range: [70, 85], score_bonus: 8 },
                    fall: { temp_range: [55, 70], score_bonus: 18 }
                },
                preferences: {
                    loves_overcast: true,
                    loves_calm: true,
                    pressure_sensitive: 40
                }
            },
            bluegill: {
                name: "Bluegill",
                phases: {
                    inactive: { temp_range: [0, 45], score_bonus: -15 },
                    cold: { temp_range: [45, 55], score_bonus: 5 },
                    pre_spawn: { temp_range: [55, 67], score_bonus: 18 },
                    spawn: { temp_range: [67, 74], score_bonus: 25 },
                    post_spawn: { temp_range: [74, 80], score_bonus: 12 },
                    summer: { temp_range: [80, 100], score_bonus: 10 }
                },
                preferences: {
                    spawn_needs_sun: true
                }
            }
        };

        const WATER_BODIES = {
            pond: { thermal_lag_days: 7, response_factor: 0.95 },
            lake: { thermal_lag_days: 14, response_factor: 0.92 },
            reservoir: { thermal_lag_days: 21, response_factor: 0.88 }
        };

        function cToF(celsius) {
            return (celsius * 9/5) + 32;
        }

        function kmhToMph(kmh) {
            return kmh * 0.621371;
        }

        function parseLocation(input) {
            // Trim whitespace
            input = input.trim();
            
            // Check if it's a zip code (5 digits)
            const zipPattern = /^\d{5}$/;
            if (zipPattern.test(input)) {
                return { type: 'zip', value: input };
            }
            
            // Check if it already has a comma
            if (input.includes(',')) {
                const parts = input.split(',').map(s => s.trim());
                if (parts.length === 2) {
                    return { type: 'city_state', city: parts[0], state: parts[1] };
                }
            }
            
            // Try to parse "City ST" format (last word is state)
            const words = input.split(/\s+/);
            if (words.length >= 2) {
                const possibleState = words[words.length - 1].toUpperCase();
                // Check if last word looks like a state (2 letters)
                if (possibleState.length === 2) {
                    const city = words.slice(0, -1).join(' ');
                    return { type: 'city_state', city: city, state: possibleState };
                }
            }
            
            // If single word or unclear format, treat as city and guess
            return { type: 'city_only', value: input };
        }

        async function getLocation(locationInput) {
            const parsed = parseLocation(locationInput);
            
            // Handle ZIP code
            if (parsed.type === 'zip') {
                const url = `https://nominatim.openstreetmap.org/search?postalcode=${parsed.value}&country=US&format=json&limit=1`;
                
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'FishCast/1.0' }
                });
                
                const data = await response.json();
                if (data && data.length > 0) {
                    // Extract city and state from display_name
                    const displayName = data[0].display_name;
                    const parts = displayName.split(', ');
                    let cityName = parts[0];
                    let stateName = parts.length > 2 ? parts[parts.length - 2] : 'US';
                    
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon),
                        name: `${cityName}, ${stateName}`
                    };
                }
                throw new Error(`ZIP code ${parsed.value} not found`);
            }
            
            // Handle city, state format
            if (parsed.type === 'city_state') {
                const url = `https://nominatim.openstreetmap.org/search?q=${parsed.city},${parsed.state},US&format=json&limit=1`;
                
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'FishCast/1.0' }
                });
                
                const data = await response.json();
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon),
                        name: `${parsed.city}, ${parsed.state}`
                    };
                }
                throw new Error(`Location "${parsed.city}, ${parsed.state}" not found. Please check spelling.`);
            }
            
            // Handle city only - try to find in US
            if (parsed.type === 'city_only') {
                const url = `https://nominatim.openstreetmap.org/search?q=${parsed.value},US&format=json&limit=1`;
                
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'FishCast/1.0' }
                });
                
                const data = await response.json();
                if (data && data.length > 0) {
                    const displayName = data[0].display_name;
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon),
                        name: displayName
                    };
                }
                throw new Error(`Location "${parsed.value}" not found. Try: "City, State" or ZIP code.`);
            }
            
            throw new Error('Invalid location format. Use "City, State" or ZIP code.');
        }

        async function getWeather(lat, lon, days) {
            // Historical data
            const endDate = new Date().toISOString().split('T')[0];
            const startDate = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            const historicalUrl = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${startDate}&end_date=${endDate}&daily=temperature_2m_mean&timezone=auto`;
            
            const historicalResponse = await fetch(historicalUrl);
            const historicalData = await historicalResponse.json();
            
            // Forecast data
            const forecastUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,surface_pressure,wind_speed_10m,wind_direction_10m,cloud_cover,weather_code&hourly=temperature_2m,surface_pressure,wind_speed_10m,cloud_cover,weather_code,precipitation_probability&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=auto&forecast_days=${days}`;
            
            const forecastResponse = await fetch(forecastUrl);
            const forecastData = await forecastResponse.json();
            
            return { historical: historicalData, forecast: forecastData };
        }

        function estimateWaterTemp(airTemps, waterType) {
            if (!airTemps || airTemps.length === 0) return 50;
            
            const body = WATER_BODIES[waterType];
            const lagDays = body.thermal_lag_days;
            const relevantTemps = airTemps.slice(-lagDays);
            
            let weightedSum = 0;
            let totalWeight = 0;
            
            relevantTemps.forEach((temp, i) => {
                const age = relevantTemps.length - i - 1;
                const weight = Math.pow(2, -age / 3);
                weightedSum += temp * weight;
                totalWeight += weight;
            });
            
            const weightedAvg = weightedSum / totalWeight;
            let waterTemp = weightedAvg * body.response_factor + 5.0;
            
            return Math.max(32, Math.min(95, waterTemp));
        }

        function getFishPhase(waterTemp, speciesData) {
            for (const [phaseName, phaseData] of Object.entries(speciesData.phases)) {
                const [min, max] = phaseData.temp_range;
                if (waterTemp >= min && waterTemp < max) {
                    return { name: phaseName, data: phaseData };
                }
            }
            const firstPhase = Object.keys(speciesData.phases)[0];
            return { name: firstPhase, data: speciesData.phases[firstPhase] };
        }

        function getPressureTrend(pressureList) {
            if (pressureList.length < 2) return 'stable';
            
            const change = pressureList[pressureList.length - 1] - pressureList[0];
            const hours = pressureList.length - 1;
            const rate = change / hours;
            
            if (rate < -2) return 'rapid_fall';
            if (rate < -0.5) return 'falling';
            if (rate > 2) return 'rapid_rise';
            if (rate > 0.5) return 'rising';
            return 'stable';
        }

        // EXACT calculation from biology.py
        function calculateFishingScore(weather, waterTemp, speciesData, speciesKey) {
            let score = 50;
            const factors = [];
            const prefs = speciesData.preferences;
            
            // 1. PRESSURE TREND
            const pressures = weather.hourly.surface_pressure.slice(0, 6);
            const pTrend = getPressureTrend(pressures);
            
            if (pTrend === 'rapid_fall') {
                const bonus = speciesKey === 'crappie' ? 40 : 35;
                score += bonus;
                factors.push({ name: 'Rapid pressure fall', value: bonus });
            } else if (pTrend === 'falling') {
                const bonus = speciesKey === 'crappie' ? 30 : 25;
                score += bonus;
                factors.push({ name: 'Falling pressure', value: bonus });
            } else if (pTrend === 'rising') {
                score -= 5;
                factors.push({ name: 'Rising pressure', value: -5 });
            }
            
            // 2. FISH PHASE
            const phase = getFishPhase(waterTemp, speciesData);
            let phaseBonus = phase.data.score_bonus;
            
            if (waterTemp < 50) {
                phaseBonus -= 20;
                factors.push({ name: 'Winter cold override', value: -20 });
            }
            
            score += phaseBonus;
            factors.push({ name: phase.name.replace('_', ' ') + ' phase', value: phaseBonus });
            
            // 3. WIND
            const windSpeed = kmhToMph(weather.current.wind_speed_10m);
            
            if (speciesKey === 'bass') {
                // Bass love wind! Research shows catch rates double with wind >15mph
                // Ideal: 5-15 mph (creates ripple, oxygenates water, masks lures)
                const windIdeal = prefs.wind_ideal || [5, 15];
                
                if (windSpeed >= windIdeal[0] && windSpeed <= windIdeal[1]) {
                    score += 15;
                } else if (windSpeed > 20) {
                    score -= 10;
                } else if (windSpeed > 15) {
                    score += 5;
                } else {  // < 5 mph (calm)
                    score += 5;
                }
            } else if (speciesKey === 'crappie') {
                if (windSpeed < 5) {
                    score += 15;
                } else if (windSpeed < 8) {
                    score += 5;
                } else if (windSpeed > 10) {
                    score -= 12;
                }
            } else {
                if (windSpeed < 12) {
                    score += 10;
                } else if (windSpeed > 15) {
                    score -= 10;
                }
            }
            
            // 4. CLOUDS
            const clouds = weather.current.cloud_cover;
            
            if (clouds >= 30 && clouds <= 70) {
                score += 10;
            } else if (clouds > 70) {
                if (speciesKey === 'crappie') {
                    score += 15;
                } else if (speciesKey === 'bass') {
                    score += 8;
                } else if (speciesKey === 'bluegill' && prefs.spawn_needs_sun && waterTemp >= 67 && waterTemp <= 74) {
                    score -= 5;
                }
            }
            
            // 5. WEATHER CODE
            const code = weather.current.weather_code;
            
            if (code === 51 || code === 53 || code === 61) {
                if (speciesKey === 'bass' && prefs.loves_light_rain) {
                    if (pTrend === 'falling' || pTrend === 'rapid_fall') {
                        score += 20;
                    } else {
                        score += 10;
                    }
                } else if (speciesKey === 'crappie') {
                    score += 5;
                }
            } else if (code === 45 || code === 48) {
                const bonus = speciesKey === 'crappie' ? 20 : 15;
                score += bonus;
            } else if (code === 95 || code === 96 || code === 99) {
                score -= 40;
            } else if (code === 63 || code === 65 || code === 80 || code === 81 || code === 82) {
                const penalty = speciesKey === 'crappie' ? -15 : -12;
                score += penalty;
            }
            
            // 6. PRECIP PROB
            const precipProb = weather.hourly.precipitation_probability[0] || 0;
            if (precipProb > 70 && code !== 51 && code !== 53 && code !== 61) {
                score -= 10;
            }
            
            score = Math.max(0, Math.min(100, Math.round(score)));
            
            let rating = 'BAD';
            let colorClass = 'bad';
            if (score >= 80) { rating = 'EXCELLENT'; colorClass = 'excellent'; }
            else if (score >= 65) { rating = 'GOOD'; colorClass = 'good'; }
            else if (score >= 50) { rating = 'FAIR'; colorClass = 'fair'; }
            else if (score >= 35) { rating = 'POOR'; colorClass = 'poor'; }
            
            return { score, rating, colorClass, factors, phase: phase.name };
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T12:00:00');
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}`;
        }

        async function generateForecast(location, speciesKey, waterType, days) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing conditions...</p></div>';
            
            try {
                const coords = await getLocation(location);
                const { historical, forecast } = await getWeather(coords.lat, coords.lon, days);
                
                const historicalTemps = historical.daily.temperature_2m_mean.map(t => cToF(t));
                const currentWaterTemp = estimateWaterTemp(historicalTemps, waterType);
                
                const speciesData = SPECIES_DATA[speciesKey];
                const currentScore = calculateFishingScore(forecast, currentWaterTemp, speciesData, speciesKey);
                
                let html = `
                    <div class="score-header">
                        <h2>Today's Forecast</h2>
                        <div class="score-display ${currentScore.colorClass}">${currentScore.score}</div>
                        <div class="rating ${currentScore.colorClass}">${currentScore.rating}</div>
                        <div class="location-info">
                            ${coords.name} | ${speciesData.name}
                        </div>
                        <div class="location-info" style="font-size: 0.9rem; margin-top: 10px;">
                            Water Temp: ${currentWaterTemp.toFixed(1)}°F | 
                            Air Temp: ${cToF(forecast.current.temperature_2m).toFixed(1)}°F
                        </div>
                    </div>
                    
                    <div class="forecast-grid">
                `;
                
                // Daily forecasts - skip index 0 (today already shown)
                for (let i = 1; i < forecast.daily.time.length; i++) {
                    const date = forecast.daily.time[i];
                    
                    // Build future temps array
                    const futureAirTemps = [...historicalTemps];
                    for (let j = 1; j <= i; j++) {
                        const futureAvg = (cToF(forecast.daily.temperature_2m_max[j]) + cToF(forecast.daily.temperature_2m_min[j])) / 2;
                        futureAirTemps.push(futureAvg);
                    }
                    const dayWaterTemp = estimateWaterTemp(futureAirTemps, waterType);
                    
                    const hourIndex = i * 24 + 12;
                    const safeHourIndex = Math.min(hourIndex, forecast.hourly.cloud_cover.length - 1);
                    
                    const dayWeather = {
                        current: {
                            temperature_2m: forecast.daily.temperature_2m_max[i],
                            cloud_cover: forecast.hourly.cloud_cover[safeHourIndex] || 50,
                            wind_speed_10m: forecast.hourly.wind_speed_10m[safeHourIndex] || 0,
                            weather_code: forecast.hourly.weather_code[safeHourIndex] || 0
                        },
                        hourly: {
                            surface_pressure: forecast.hourly.surface_pressure.slice(
                                Math.max(0, safeHourIndex - 6),
                                safeHourIndex
                            ),
                            precipitation_probability: [forecast.hourly.precipitation_probability[safeHourIndex] || 0]
                        }
                    };
                    
                    const dayScore = calculateFishingScore(dayWeather, dayWaterTemp, speciesData, speciesKey);
                    const windSpeed = kmhToMph(dayWeather.current.wind_speed_10m);
                    const precip = forecast.daily.precipitation_probability_max[i] || 0;
                    
                    html += `
                        <div class="day-card">
                            <div class="day-header">${formatDate(date)}</div>
                            <div class="day-score ${dayScore.colorClass}">${dayScore.score}</div>
                            <div class="day-rating ${dayScore.colorClass}">${dayScore.rating}</div>
                            <div class="weather-detail">
                                <span class="weather-label">Water Temp</span>
                                <span class="weather-value">${dayWaterTemp.toFixed(1)}°F</span>
                            </div>
                            <div class="weather-detail">
                                <span class="weather-label">Air Temp</span>
                                <span class="weather-value">${cToF(forecast.daily.temperature_2m_max[i]).toFixed(0)}° / ${cToF(forecast.daily.temperature_2m_min[i]).toFixed(0)}°F</span>
                            </div>
                            <div class="weather-detail">
                                <span class="weather-label">Wind</span>
                                <span class="weather-value">${windSpeed.toFixed(1)} mph</span>
                            </div>
                            <div class="weather-detail">
                                <span class="weather-label">Precip</span>
                                <span class="weather-value">${precip}%</span>
                            </div>
                            <div class="weather-detail">
                                <span class="weather-label">Phase</span>
                                <span class="weather-value">${dayScore.phase.replace('_', ' ')}</span>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                resultsDiv.innerHTML = html;
                resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
            } catch (error) {
                console.error('Error:', error);
                
                let errorMessage = error.message || 'Could not generate forecast. Please try again.';
                let hint = '';
                
                // Provide helpful hints based on error type
                if (error.message && error.message.includes('not found')) {
                    hint = '<div class="hint"><strong>Tips:</strong><br>• Use format: "City, State" (e.g., "Tupelo, MS")<br>• Or just: "City ST" (e.g., "Memphis TN")<br>• Or ZIP code (e.g., "38801")<br>• Check spelling of city name</div>';
                }
                
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>⚠ Error</h3>
                        <p>${errorMessage}</p>
                        ${hint}
                    </div>
                `;
            }
        }

        document.getElementById('forecastForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const location = document.getElementById('location').value;
            const species = document.getElementById('species').value;
            const waterType = document.getElementById('waterType').value;
            const days = parseInt(document.getElementById('days').value);
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Generating...';
            
            await generateForecast(location, species, waterType, days);
            
            submitBtn.disabled = false;
            submitBtn.textContent = 'Generate Forecast';
        });

        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }
    </script>
</body>
</html>
